<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>3.2.1.4.2.1. Synchronization Commands</title><link rel="stylesheet" href="Common_Content/css/default.css" type="text/css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.5" /><meta name="package" content="Beaker-Deployment_Guide-0.5-en-US-1-9" /><link rel="home" href="index.html" title="Deployment Guide" /><link rel="up" href="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests.html" title="3.2.1.4.2. Writing and Running Multihosts Tasks" /><link rel="prev" href="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests.html" title="3.2.1.4.2. Writing and Running Multihosts Tasks" /><link rel="next" href="User_Guide-Getting_Started-Process-Tests-Unassimilated_or_Unfinsihed_Content.html" title="3.2.1.4.3. Unassimilated or Unfinished content" /></head><body><p id="title"><a class="left" href="https://fedorahosted.org/publican"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="https://fedorahosted.org/publican"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="User_Guide-Getting_Started-Process-Tests-Unassimilated_or_Unfinsihed_Content.html"><strong>Next</strong></a></li></ul><div class="section" id="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests-Synchronization_Commands"><div class="titlepage"><div><div><h6 class="title" id="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests-Synchronization_Commands">3.2.1.4.2.1. Synchronization Commands</h6></div></div></div><div class="para">
			Synchronization of machines within a multihost test is performed using per-host state strings managed on the Beaker server. Each machine's starting state is the empty string.
		</div><pre class="screen">rhts-sync-set -s state 
</pre><div class="para">
			The rhts-sync-set command sets the state of this machine within the test to the given value.
		</div><pre class="screen">rhts-sync-block -s state [hostnames...] 
</pre><div class="para">
			The rhts-sync-block command blocks further execution of this instance of the script until all of the listed hosts are in the given state.
		</div><div class="para">
			Unfortunately, there is currently no good way to run these commands in the standalone helper environment.
		</div><div class="section" id="User_Guide-Getting_Started-Process-Writing_and_Running_Multihosts_Tests-Synchronization_Commands-Examples_of_a_runtest_sh_for_a_multihost_test"><div class="titlepage"><div><div><h6 class="title" id="User_Guide-Getting_Started-Process-Writing_and_Running_Multihosts_Tests-Synchronization_Commands-Examples_of_a_runtest_sh_for_a_multihost_test">3.2.1.4.2.1.1. Example of a runtest.sh for a multihost test</h6></div></div></div><pre class="screen">#!/bin/sh
# Source the common test script helpers                                       
. /usr/bin/rhts_environment.sh

# Save STDOUT and STDERR, and redirect everything to a file.
exec 5&gt;&amp;1 6&gt;&amp;2
exec &gt;&gt; "${OUTPUTFILE}" 2&gt;&amp;1

client()
{
    echo "-- wait the server to finish."
    rhts_sync_block -s "DONE" ${SERVERS}

    user="finger1"
    for i in ${SERVERS}
    do
        echo "-- finger user \"$user\" from server \"${i}\"."
        ./finger_client "${i}" "${user}"
        # It returns non-zero for failure.
        if [ $? -ne 0 ]; then
            rhts_sync_set -s "DONE"
            report_result "${TEST}" "FAIL" 0
            exit 1
        fi
    done

    echo "-- client finishes."
    rhts_sync_set -s "DONE"
    result="PASS"
}

server()
{
    # Start server and check it is up and running.
    /sbin/chkconfig finger on &amp;&amp; sleep 5
    if ! netstat -a | grep "finger" ; then
        rhts_sync_set -s "DONE"
        report_result "${TEST}" "FAIL" 0
        exit 1
    fi
    useradd finger1
    echo "-- server finishes."
    rhts_sync_set -s "DONE"
    rhts_sync_block -s "DONE" ${CLIENTS}
    result="PASS"
}

# ---------- Start Test -------------
result="FAIL"
if echo "${CLIENTS}" | grep "${HOSTNAME}" &gt;/dev/null; then
    echo "-- run finger test as client."
    TEST=${TEST}/client
    client
fi
if echo "${SERVERS}" | grep "${HOSTNAME}" &gt;/dev/null; then
    echo "-- run finger test as server."
    TEST=${TEST}/server
    server
fi
echo "--- end of runtest.sh."
report_result "${TEST}" "${result}" 0
exit 0</pre></div><div class="section" id="User_Guide-Getting_Started-Tests-Process-Writing_and_Running_Multihosts_Tests-Synchronization_Commands-Tuning_up_multihost_tests"><div class="titlepage"><div><div><h6 class="title" id="User_Guide-Getting_Started-Tests-Process-Writing_and_Running_Multihosts_Tests-Synchronization_Commands-Tuning_up_multihost_tests">3.2.1.4.2.1.2. Tuning up multihost tests</h6></div></div></div><div class="para">
				Multihost tests can be easily tuned up outside Beaker using following code snippet based on $JOBID variable (which is set when running in Beaker environment). Just log in to two machines (let's say: client.example.com and server.example.com) and add following lines at the beginning of your runtest.sh script.
			</div><pre class="screen"># decide if we're runnig on RHTS or in developer mode
if test -z $JOBID ; then
        echo "Variable JOBID not set, assuming developer mode"
        CLIENTS="client.example.com"
        SERVERS="server.example.com"
else
        echo "Variable JOBID set, we're running on RHTS"
fi
echo "Clients: $CLIENTS"
echo "Servers: $SERVERS"</pre><div class="para">
				Then you just run the script on both client and server. When scripts reach one of the synchronization commands (rhts-sync-set or rhts-sync-block) you will be asked for supplying actual state of the client/server by keyboard (usually just confirm readiness by hitting Enter). That's it! :-)
			</div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="User_Guide-Getting_Started-Process-Tests-Writing_and_Running_Multihosts_Tests.html"><strong>Prev</strong>3.2.1.4.2. Writing and Running Multihosts Tasks</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="User_Guide-Getting_Started-Process-Tests-Unassimilated_or_Unfinsihed_Content.html"><strong>Next</strong>3.2.1.4.3. Unassimilated or Unfinished content</a></li></ul></body></html>
